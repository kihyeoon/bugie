name: Process Account Deletions

on:
  schedule:
    # ë§¤ì¼ í•œêµ­ì‹œê°„ ìƒˆë²½ 3ì‹œ ì‹¤í–‰ (UTC 18:00)
    - cron: '0 18 * * *'

  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode (ì‹¤ì œ ì‚­ì œí•˜ì§€ ì•Šê³  ì‹œë®¬ë ˆì´ì…˜ë§Œ)'
        type: boolean
        default: false
        required: false

jobs:
  process-deletions:
    name: Process Account Deletions
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      NODE_ENV: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: |
          pnpm add -D @supabase/supabase-js --filter root

      - name: Process account deletions
        id: process
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          DRY_RUN: ${{ inputs.dry_run || 'false' }}
        run: |
          echo "ğŸš€ Starting account deletion process..."
          echo "Dry run mode: $DRY_RUN"
          echo "Timestamp: $(date)"

          node scripts/process-deletions.js

          echo "âœ… Process completed"

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deletion-logs-${{ github.run_id }}
          path: |
            deletion-*.log
          retention-days: 30

      - name: Send success notification
        if: success() && github.event_name == 'schedule'
        run: |
          echo "âœ… Account deletion process completed successfully"
          echo "Run ID: ${{ github.run_id }}"
          echo "Run Number: ${{ github.run_number }}"
          # TODO: Slack/Discord/Email ì•Œë¦¼ ì¶”ê°€ ê°€ëŠ¥

      - name: Send failure notification
        if: failure()
        run: |
          echo "âŒ Account deletion process failed"
          echo "Run ID: ${{ github.run_id }}"
          echo "Error details available in GitHub Actions logs"
          # TODO: ê¸´ê¸‰ ì•Œë¦¼ ë°œì†¡ (Slack/Discord/Email)

      - name: Create issue on failure
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ Account Deletion Job Failed - ${new Date().toISOString().split('T')[0]}`,
              body: `## Account Deletion Job Failed
              
              **Run ID**: ${context.runId}
              **Run Number**: ${context.runNumber}
              **Triggered by**: ${context.eventName}
              
              ### Action Required
              1. Check the [workflow logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              2. Review Supabase logs for errors
              3. Run manual retry if needed
              
              ### Manual Retry
              \`\`\`bash
              # Dry run first
              gh workflow run process-account-deletions.yml -f dry_run=true
              
              # Actual run
              gh workflow run process-account-deletions.yml -f dry_run=false
              \`\`\`
              
              cc @${context.repo.owner}`,
              labels: ['bug', 'automation', 'priority-high']
            });
            console.log(`Created issue #${issue.data.number}`);

# Security notes:
# - SUPABASE_SERVICE_KEY must be kept secret
# - Only service_role key should be used (never anon key)
# - Logs should not contain sensitive information
# - Consider IP allowlisting for production
